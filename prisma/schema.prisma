// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NEW: Enum for strict type safety on analysis results
enum PriceChange {
  PriceIncrease
  PriceDecrease
  NoChange
}

model AppState {
  key   String @id @unique
  value String
}

model Item {
  id        Int      @id @unique
  name      String
  examine   String?
  members   Boolean
  limit     Int?
  value     Int
  icon      String?
  highalch  Int?
  lowalch   Int?
  prices    PriceSnapshot[] // MODIFIED: Changed to PriceSnapshot
  analyses  ItemAnalysis[]
}

// MODIFIED: This model is now purpose-built for periodic snapshots
model PriceSnapshot {
  id           Int      @id @default(autoincrement())
  itemId       Int
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  highPrice    Int
  lowPrice     Int
  snapshotTime DateTime

  @@unique([itemId, snapshotTime])
  @@index([snapshotTime])
}

model Post {
  id         Int      @id
  title      String
  link       String   @unique
  content    String
  createdAt  DateTime @default(now())
  isAnalyzed Boolean  @default(false)
  analyses ItemAnalysis[]
}

model ItemAnalysis {
  id                  Int         @id @default(autoincrement())
  postId              Int
  post                Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  itemId              Int
  item                Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  relevantTextSnippet String
  expectedPriceChange PriceChange // MODIFIED: Using the enum for data integrity
  createdAt           DateTime    @default(now())

  @@unique([postId, itemId])
}

// ============================================================================
// BENCHMARK TABLES - For tracking model performance over time
// ============================================================================

// Stores algorithm versions with a hash of core extraction components
model BenchmarkAlgorithm {
  id            Int      @id @default(autoincrement())
  hash          String   @unique // SHA-256 of core component files
  description   String?  // Optional description of changes
  createdAt     DateTime @default(now())

  // Files included in hash (stored as JSON array)
  hashedFiles   String   // e.g., ["src/itemExtractor.js", "src/contentCleaner.js"]

  runs          BenchmarkRun[]
}

// Stores individual benchmark runs
model BenchmarkRun {
  id              Int       @id @default(autoincrement())
  algorithmId     Int
  algorithm       BenchmarkAlgorithm @relation(fields: [algorithmId], references: [id], onDelete: Cascade)

  // Model configuration
  model           String    // e.g., "o4-mini", "gpt-5-mini"
  reasoningEffort String?   // e.g., "low", "medium", "high"
  configKey       String    // Combined key e.g., "o4-mini:low"

  // Run metadata
  runNumber       Int       // Which run in the series (1-10, etc.)
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  // Aggregate metrics for this run
  totalTp         Int       @default(0)
  totalFp         Int       @default(0)
  totalFn         Int       @default(0)
  precision       Float?
  recall          Float?
  f1              Float?

  // Token usage
  totalPromptTokens     Int @default(0)
  totalCompletionTokens Int @default(0)
  totalReasoningTokens  Int @default(0)

  // Timing
  totalLatencyMs  Int       @default(0)

  results         BenchmarkPostResult[]

  @@index([algorithmId, configKey])
}

// Stores per-post results for each run
model BenchmarkPostResult {
  id          Int           @id @default(autoincrement())
  runId       Int
  run         BenchmarkRun  @relation(fields: [runId], references: [id], onDelete: Cascade)

  postId      Int           // References the test post ID
  postTitle   String

  // Metrics for this post
  tp          Int
  fp          Int
  fn          Int
  precision   Float?
  recall      Float?
  f1          Float?

  // Token usage for this post
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  reasoningTokens  Int @default(0)

  // Timing
  latencyMs   Int

  // Error tracking
  error       String?

  @@unique([runId, postId])
}